<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yamu.data.sample.service.resources.mapper.PartnerDomainTopNChangeMapper">

    <select id="countFindRankNumberByParam" resultType="java.lang.Long">
        select count(1) from
        (
        <if test="queryParam.rankNumber != null">
            select domain_name, rank_number from (
        </if>
        select
        domain_name,
        sum(parse_total_cnt) as parse_total_cnt,
        row_number() OVER (ORDER BY parse_total_cnt DESC) rank_number
        from ${resultTable}
        <where>
            <include refid="selectiveParamNotContainParseTime"/>
        </where>
        group by domain_name
        <if test="queryParam.rankNumber != null">
            ) where rank_number &lt;= #{queryParam.rankNumber}
        </if>
        )
        settings allow_experimental_window_functions = 1
    </select>
    <select id="findRankNumberByParam"
            resultType="com.yamu.data.sample.service.resources.entity.po.PartnerDomainTopNChange">
        <if test="queryParam.rankNumber != null">
            select domain_name, parse_total_cnt, last_parse_total_cnt, parse_variation_cnt, rank_number, last_rank_number from (
        </if>
        select domain_name,
        sum(parse_total_cnt) as parse_total_cnt,
        sum(last_parse_total_cnt) as last_parse_total_cnt,
        minus(parse_total_cnt, last_parse_total_cnt) as parse_variation_cnt,
        row_number() OVER (ORDER BY parse_total_cnt DESC) rank_number,
        row_number() OVER (ORDER BY last_parse_total_cnt DESC) last_rank_number
        from ${resultTable}
        <where>
            <include refid="selectiveParamNotContainParseTime"/>
        </where>
        group by domain_name
        order by parse_total_cnt desc
        <if test="queryParam.rankNumber != null">
            ) where rank_number &lt;= #{queryParam.rankNumber}
        </if>
        limit #{queryParam.offset}, #{queryParam.limit}
        settings allow_experimental_window_functions = 1
    </select>

    <sql id="selectiveParamNotContainParseTime">
        <if test="queryParam.domainName != null and queryParam.domainName != ''">and domain_name ilike concat('%',#{queryParam.domainName},'%')</if>
        <if test="queryParam.districtsCode != null and queryParam.districtsCode != ''">and districts_code = #{queryParam.districtsCode}</if>
        <if test="queryParam.country != null and queryParam.country != ''">and country = #{queryParam.country}</if>
        <if test="queryParam.province != null and queryParam.province != ''">and province = #{queryParam.province}</if>
        <if test="queryParam.city != null and queryParam.city != ''">and city = #{queryParam.city}</if>
        <if test="queryParam.district != null and queryParam.district != ''">and district = #{queryParam.district}</if>
        <if test="queryParam.isp != null and queryParam.isp != ''">and isp = #{queryParam.isp}</if>
        <if test="queryParam.ispCode != null and queryParam.ispCode != ''">and isp_code = #{queryParam.ispCode}</if>
    </sql>
</mapper>
