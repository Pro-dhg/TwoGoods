<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yamu.data.sample.service.resources.mapper.PopularCompanyTopNMapper">

    <select id="countFindRankNumberByParam" resultType="java.lang.Long">
        select count(*) from (
            select company_short_name
            from ${resultTable}
            <where>
                <include refid="selectiveParamNotContainParseTime"/>
            </where>
            group by company_short_name
            order by sum(parse_total_cnt) desc
            <if test="queryParam.rankNumber != null and queryParam.rankNumber != '' ">
                limit #{queryParam.rankNumber}
            </if>
        )
    </select>
    <select id="findRankNumberByParam"
            resultType="com.yamu.data.sample.service.resources.entity.po.PopularCompanyTopN">
        select company_short_name,
        parse_total_cnt,
        rank_number,
        last_parse_total_cnt,
        last_rank_number,
        (t1.parse_total_cnt - t2.last_parse_total_cnt) as parse_variation_cnt
        from (
        select company_short_name,
        parse_total_cnt,
        rank_number from (
        select company_short_name,
        sum(parse_total_cnt) as parse_total_cnt,
        row_number() over(order by parse_total_cnt desc) rank_number
        from ${resultTable}
        <where>
            <include refid="selectiveParamNotContainParseTime"/>
        </where>
        group by company_short_name
        order by rank_number
        <if test="queryParam.rankNumber != null and queryParam.rankNumber != ''">
            limit #{queryParam.rankNumber}
        </if>
        )
        <!--使用where分页,提升查询效率-->
        <where>
            <choose>
                <when test="queryParam.limit != null and queryParam.limit !='' and queryParam.offset != null and queryParam.offset != ''">
                    and rank_number &gt; #{queryParam.offset}
                    and rank_number &lt;= (#{queryParam.offset} + #{queryParam.limit})
                </when>
                <when test="queryParam.limit != null and queryParam.limit !='' and (queryParam.offset == null or queryParam.offset == '')">
                    and rank_number between 1 and #{queryParam.limit}
                </when>
            </choose>
        </where>
        ) t1 left join (
        select company_short_name,
        sum(parse_total_cnt) as last_parse_total_cnt,
        row_number() over(order by last_parse_total_cnt desc) last_rank_number
        from ${easierResultTable}
        <where>
            <include refid="selectiveParamNotContainParseTime"/>
        </where>
        group by company_short_name
        ) t2 on t1.company_short_name = t2.company_short_name
        settings allow_experimental_window_functions = 1

    </select>

    <sql id="selectiveParamNotContainParseTime">
        <if test="queryParam.businessIp != null and queryParam.businessIp != ''">and business_ip = #{queryParam.businessIp}</if>
        <if test="queryParam.companyShortName != null and queryParam.companyShortName != ''">and company_short_name ilike concat('%',#{queryParam.companyShortName},'%')</if>
        <if test="queryParam.districtsCode != null and queryParam.districtsCode != ''">and districts_code = #{queryParam.districtsCode}</if>
        <if test="queryParam.country != null and queryParam.country != ''">and country = #{queryParam.country}</if>
        <if test="queryParam.province != null and queryParam.province != ''">and province = #{queryParam.province}</if>
        <if test="queryParam.city != null and queryParam.city != ''">and city = #{queryParam.city}</if>
        <if test="queryParam.district != null and queryParam.district != ''">and district = #{queryParam.district}</if>
        <if test="queryParam.isp != null and queryParam.isp != ''">and isp = #{queryParam.isp}</if>
        <if test="queryParam.ispCode != null and queryParam.ispCode != ''">and isp_code = #{queryParam.ispCode}</if>
        <if test="queryParam.serverNodeName !=null and queryParam.serverNodeName !=''">and server_node_name = #{queryParam.serverNodeName}</if>
    </sql>
</mapper>
