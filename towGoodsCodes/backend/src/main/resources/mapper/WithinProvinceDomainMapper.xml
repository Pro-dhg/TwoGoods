<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yamu.data.sample.service.resources.mapper.WithinProvinceDomainMapper">
    <!--本省域名排名趋势-->

    <select id="findWithinProvinceDomainTopNByParam" resultType="com.yamu.data.sample.service.resources.entity.po.WithinProvinceDomain">
        select
        domain_name,
        parseTotalCnt,
        lastParseTotalCnt
        from(
        select domain_name,
               sum(parse_total_cnt) parseTotalCnt,
               sum(last_parse_total_cnt) lastParseTotalCnt
        from ${queryParam.queryTable}
        <where>
            <include refid="selectiveParamByReport"/>
            <if test = "queryParam.rankNumber != null and queryParam.rankNumber != ''">
            and domain_name global in (
                select
                    domain_name
                from
                    ${queryParam.queryTable}
                <where>
                    <if test="queryParam.startTime != null">parse_time &gt;= #{queryParam.startTime}</if>
                    <if test="queryParam.endTime != null">and parse_time &lt;= #{queryParam.endTime}</if>
                </where>
                group by
                    domain_name
                order by sum(parse_total_cnt) desc limit #{queryParam.rankNumber}
                )
            </if>
        </where>
        group by domain_name,parse_time
        order by parse_time,parseTotalCnt desc
        limit #{queryParam.offset}, #{queryParam.limit}
        )
        order by parseTotalCnt desc
    </select>

    <select id="countFindTrendParam" resultType="java.lang.Long">
        select count(1) from
        (
        select domain_name,
        sum(parse_total_cnt) parseTotalCnt,
        sum(last_parse_total_cnt) lastParseTotalCnt
        from ${queryParam.queryTable}
        <where>
            <if test="queryParam.startTime != null">and parse_time &gt;= #{queryParam.startTime}</if>
            <if test="queryParam.endTime != null">and parse_time &lt;= #{queryParam.endTime}</if>
            <if test="queryParam.province != null and queryParam.province != ''">and province = #{queryParam.province}</if>
            <if test="queryParam.city != null and queryParam.city != ''">and city = #{queryParam.city}</if>
            <if test = "queryParam.ispCode != null and queryParam.ispCode != ''">and isp_code = #{queryParam.ispCode} </if>
            <if test = "queryParam.domainName != null and queryParam.domainName != ''">and domain_name ilike concat('%',#{queryParam.domainName},'%') </if>
        </where>
        group by domain_name,parse_time
        <if test = "queryParam.rankNumber != null and queryParam.rankNumber != ''"> rank_number &lt;= #{queryParam.rankNumber} </if>
        )
    </select>
    <sql id="selectiveParamByReport">
        <if test="queryParam.startTime != null and queryParam.startTime != ''">and parse_time &gt;= #{queryParam.startTime}</if>
        <if test="queryParam.endTime != null and queryParam.endTime != ''">and parse_time &lt;= #{queryParam.endTime}</if>
        <if test = "queryParam.domainName != null and queryParam.domainName != ''">and domain_name ilike concat('%',#{queryParam.domainName},'%') </if>
        <if test="queryParam.districtsCode != null and queryParam.districtsCode != ''">and districts_code = #{queryParam.districtsCode}</if>
        <if test="queryParam.country != null and queryParam.country != ''">and country = #{queryParam.country}</if>
        <if test="queryParam.province != null and queryParam.province != ''">and province = #{queryParam.province}</if>
        <if test="queryParam.city != null and queryParam.city != ''">and city = #{queryParam.city}</if>
        <if test="queryParam.district != null and queryParam.district != ''">and district = #{queryParam.district}</if>
        <if test="queryParam.isp != null and queryParam.isp != ''">and isp = #{queryParam.isp}</if>
        <if test="queryParam.ispCode != null and queryParam.ispCode != ''">and isp_code = #{queryParam.ispCode}</if>
    </sql>

</mapper>
