<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yamu.data.sample.service.resources.mapper.ResourceWebsiteTopNDetailMapper">

    <select id="countCdnReportlList" resultType="java.lang.Long">
        select count(*) from (SELECT
        <if test="queryParam.websiteAppName != null and queryParam.websiteAppName != ''">website_app_name,</if>
        business cdnBusiness,
        SUM(parse_total_cnt)  as cdnResponseCnt,
        max(o3.parse_total_cnt3) as  cdnParseTotalCnt ,
        round((SUM(parse_total_cnt)  / max(o2.parse_total_cnt2))* 100,2) as responseProportion ,
        round((SUM(parse_total_cnt)  / max(o3.parse_total_cnt3))* 100,2) as cdnResponseProportion ,
        SUM(parse_success_cnt) as successCnt ,
        round((successCnt / cdnResponseCnt)* 100,2) successRate ,
        SUM(net_in_parse_total_cnt) as netInCnt,
        round((netInCnt / cdnResponseCnt)* 100,2) as netInRate ,
        SUM(within_parse_total_cnt) as withinCnt ,
        round((withinCnt / cdnResponseCnt)* 100,2) as withinRate
        from
        ${queryParam.queryTable} ,(
        select
        sum(parse_total_cnt) as parse_total_cnt2
        from
        ${queryParam.aQueryTable}
        <where>
            <include refid="selectiveParamCdn2"/>
        </where>) o2 ,(select
        sum(parse_total_cnt) parse_total_cnt3
        from
        ${queryParam.queryTable}
        <where>
            <include refid="selectiveParamCdn2"/>
        </where>) o3
        <where>
            <include refid="selectiveParamCdn2"/>
        </where>

        and website_app_name GLOBAL in (
        select website_app_name from (
        select
        website_app_name
        from
        (
        select
        website_app_name,
        SUM(parse_total_cnt) as parse_total_cnt,
        SUM(a_record_parse_total_cnt) as a_record_parse_total_cnt,
        SUM(net_in_parse_total_cnt) as net_in_parse_total_cnt,
        if(a_record_parse_total_cnt == 0,
        0.0,
        divide(net_in_parse_total_cnt * 100,
        a_record_parse_total_cnt)) as net_in_rate_val
        from
        ${queryParam.aQueryTable}
        <where>
            <include refid="selectiveParamCdnTime2"/>
            <if test="queryParam.rankNumber != null and queryParam.rankNumber != ''">

                and
                website_app_name global in (
                select website_app_name from (
                select
                website_app_name
                from
                ${queryParam.aQueryTable}
                <where>
                    <include refid="selectiveParamCdn2"/>
                </where>
                group by
                website_app_name
                HAVING
                1 = 1
                order by
                sum (parse_total_cnt) desc
                <if test="queryParam.rankNumber != null and queryParam.rankNumber != ''">
                    limit #{queryParam.rankNumber}
                </if>
                ))
            </if>
        </where>
        group by
        website_app_name,website_type
        <if test="queryParam.statisticsWay != null and queryParam.statisticsWay != '' and queryParam.statisticsWay == 'every'"> ,parse_time</if>
        HAVING
        1 = 1 )
        <where>
            <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null">
                <include refid="selectiveParamCdnNet"/>
            </if>
        </where>
        order by
        parse_total_cnt desc
        <if test="queryParam.rankNumber != null and queryParam.rankNumber != ''">
            limit #{queryParam.rankNumber}
        </if>
        ) )
        group by
        business
        <if test="queryParam.websiteAppName != null and queryParam.websiteAppName != ''">,website_app_name</if>
        order by cdnResponseCnt desc
        <if test="queryParam.rankNumber != null and queryParam.rankNumber != ''">
            limit #{queryParam.rankNumber}
        </if>)
        <where>
            <if test="queryParam.websiteAppName != null and queryParam.websiteAppName != ''">and website_app_name = #{queryParam.websiteAppName}</if>
        </where>
    </select>
    <select id="findCdnReport"
            resultType="com.yamu.data.sample.service.resources.entity.po.ResourceWebsiteCdnReport">
        select * from (SELECT
        business cdnBusiness,
        SUM(parse_total_cnt)  as cdnResponseCnt,
        max(o3.parse_total_cnt3) as  cdnParseTotalCnt ,
        round((SUM(parse_total_cnt)  / max(o2.parse_total_cnt2))* 100,2) as responseProportion ,
        round((SUM(parse_total_cnt)  / max(o3.parse_total_cnt3))* 100,2) as cdnResponseProportion ,
        SUM(parse_success_cnt) as successCnt ,
        round((successCnt / cdnResponseCnt)* 100,2) successRate ,
        SUM(net_in_parse_total_cnt) as netInCnt,
        round((netInCnt / cdnResponseCnt)* 100,2) as netInRate ,
        SUM(within_parse_total_cnt) as withinCnt ,
        round((withinCnt / cdnResponseCnt)* 100,2) as withinRate,
        max(o2.parse_total_cnt2) as responseCnt
        from
        ${queryParam.queryTable} ,(
        select
        sum(parse_total_cnt) as parse_total_cnt2
        from
        ${queryParam.aQueryTable}
        <where>
            <include refid="selectiveParamCdn2"/>
        </where>) o2 ,(select
        sum(parse_total_cnt) parse_total_cnt3
        from
        ${queryParam.queryTable}
        <where>
            <include refid="selectiveParamCdn2"/>
        </where>) o3
        <where>
            <include refid="selectiveParamCdn2"/>
        </where>

        and website_app_name GLOBAL in (
        select website_app_name from (
        select
        website_app_name
        from
        (
        select
        website_app_name,
        SUM(parse_total_cnt) as parse_total_cnt,
        SUM(a_record_parse_total_cnt) as a_record_parse_total_cnt,
        SUM(net_in_parse_total_cnt) as net_in_parse_total_cnt,
        if(a_record_parse_total_cnt == 0,
        0.0,
        divide(net_in_parse_total_cnt * 100,
        a_record_parse_total_cnt)) as net_in_rate_val
        from
        ${queryParam.aQueryTable}
        <where>
            <include refid="selectiveParamCdnTime2"/>
            <if test="queryParam.websiteType != null and queryParam.websiteType != ''">and website_type = #{queryParam.websiteType}</if>
            <if test="queryParam.rankNumber != null and queryParam.rankNumber != ''">
                and
                website_app_name global in (
                select website_app_name from (
                select
                website_app_name
                from
                ${queryParam.aQueryTable}
                <where>
                    <include refid="selectiveParamCdn2"/>
                    <if test="queryParam.websiteType != null and queryParam.websiteType != ''">and website_type = #{queryParam.websiteType}</if>
                </where>
                group by
                website_app_name
                HAVING
                1 = 1
                order by
                sum (parse_total_cnt) desc
                <if test="queryParam.rankNumber != null and queryParam.rankNumber != ''">
                    limit #{queryParam.rankNumber}
                </if>
                ))
        </if>
        </where>
        group by
        website_app_name,website_type
        <if test="queryParam.statisticsWay != null and queryParam.statisticsWay != '' and queryParam.statisticsWay == 'every'"> ,parse_time</if>
        HAVING
        1 = 1 )
        <where>
            <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null">
                <include refid="selectiveParamCdnNet"/>
            </if>
        </where>
        order by
        parse_total_cnt desc
        <if test="queryParam.rankNumber != null and queryParam.rankNumber != ''">
            limit #{queryParam.rankNumber}
        </if>
        ) )
        group by
        business
        <if test="queryParam.websiteAppName != null and queryParam.websiteAppName != ''">,website_app_name</if>
        order by cdnResponseCnt desc
        <if test="queryParam.rankNumber != null and queryParam.rankNumber != ''">
            limit #{queryParam.rankNumber}
        </if>)
        limit #{queryParam.offset}, #{queryParam.limit}
    </select>

    <select id="findCdnReport2"
            resultType="com.yamu.data.sample.service.resources.entity.po.ResourceWebsiteCdnReport">
        select * from (SELECT
        <if test="queryParam.websiteAppName != null and queryParam.websiteAppName != ''">website_app_name,</if>
        business cdnBusiness,
        SUM(parse_total_cnt)  as cdnResponseCnt,
        max(o3.parse_total_cnt3) as  cdnParseTotalCnt ,
        max(o2.parse_total_cnt2) as responseCnt ,
        SUM(parse_success_cnt) as successCnt ,
        SUM(net_in_parse_total_cnt) as netInCnt,
        SUM(within_parse_total_cnt) as withinCnt
        from
        ${queryParam.queryTable} ,(
        select
        sum(parse_total_cnt) as parse_total_cnt2
        from
        ${queryParam.aQueryTable}
        <where>
            <include refid="selectiveParamCdn2"/>
        </where>) o2 ,(select
        sum(parse_total_cnt) parse_total_cnt3
        from
        ${queryParam.queryTable}
        <where>
            <include refid="selectiveParamCdn2"/>
        </where>) o3
        <where>
            <include refid="selectiveParamCdn2"/>
        </where>
        group by
        business
        <if test="queryParam.websiteAppName != null and queryParam.websiteAppName != ''">,website_app_name</if>
        order by cdnResponseCnt desc
        )
        <where>
            <if test="queryParam.websiteAppName != null and queryParam.websiteAppName != ''">and website_app_name = #{queryParam.websiteAppName}</if>
        </where>
    </select>

    <sql id="selectiveParamCdnNet">
        <if test="queryParam.netInRateMax != null and queryParam.netInRateMax != ''">and net_in_rate_val  &lt;= #{queryParam.netInRateMax}</if>
        <if test="queryParam.netInRateMin != null and queryParam.netInRateMin != ''">and net_in_rate_val >= #{queryParam.netInRateMin}</if>
    </sql>
    <sql id="selectiveParamCdnTime">
        <if test="queryParam.startTime != null and queryParam.startTime != ''">and parse_time &gt;= #{queryParam.startTime}</if>
        <if test="queryParam.endTime != null and queryParam.endTime != ''">and parse_time &lt; #{queryParam.endTime}</if>
        <if test="queryParam.websiteAppName != null and queryParam.websiteAppName != ''">and website_app_name ilike concat('%',#{queryParam.websiteAppName},'%')</if>
        <if test="queryParam.userType != null and queryParam.userType != ''">and user_type = #{queryParam.userType}</if>
        <if test="queryParam.district != null and queryParam.district != ''">and district = #{queryParam.district}</if>
        <if test="queryParam.country != null and queryParam.country != ''">and country = #{queryParam.country}</if>
        <if test="queryParam.province != null and queryParam.province != ''">and province = #{queryParam.province}</if>
        <if test="queryParam.city != null and queryParam.city != ''">and city = #{queryParam.city}</if>
        <if test="queryParam.ispCode != null and queryParam.ispCode != ''">and isp_code = #{queryParam.ispCode}</if>
        <if test="queryParam.queryTime != null and queryParam.queryTime != ''">and parse_time = #{queryParam.queryTime}</if>
        <if test="queryParam.serverNodeName !=null and queryParam.serverNodeName !=''">and server_node_name = #{queryParam.serverNodeName}</if>
    </sql>
    <sql id="selectiveParamCdn">
        <if test="queryParam.startTime != null and queryParam.startTime != ''">and parse_time &gt;= #{queryParam.startTime}</if>
        <if test="queryParam.endTime != null and queryParam.endTime != '' and queryParam.statisticsWay == 'every'">and parse_time &lt; #{queryParam.endTime}</if>
        <if test="queryParam.endTime != null and queryParam.endTime != '' and queryParam.statisticsWay != 'every'">and parse_time &lt; #{queryParam.endTime}</if>
        <if test="queryParam.websiteAppName != null and queryParam.websiteAppName != ''">and website_app_name ilike concat('%',#{queryParam.websiteAppName},'%')</if>
        <if test="queryParam.business != null and queryParam.business != ''">and business ilike concat('%',#{queryParam.business},'%')</if>
        <if test="queryParam.userType != null and queryParam.userType != ''">and user_type = #{queryParam.userType}</if>
        <if test="queryParam.districtsCode != null and queryParam.districtsCode != ''">and districts_code = #{queryParam.districtsCode}</if>
        <if test="queryParam.country != null and queryParam.country != ''">and country = #{queryParam.country}</if>
        <if test="queryParam.province != null and queryParam.province != ''">and province = #{queryParam.province}</if>
        <if test="queryParam.city != null and queryParam.city != ''">and city = #{queryParam.city}</if>
        <if test="queryParam.district != null and queryParam.district != ''">and district = #{queryParam.district}</if>
        <if test="queryParam.isp != null and queryParam.isp != ''">and isp = #{queryParam.isp}</if>
        <if test="queryParam.ispCode != null and queryParam.ispCode != ''">and isp_code = #{queryParam.ispCode}</if>
<!--        <if test="queryParam.statisticsWay != null and queryParam.statisticsWay == 'every'">  and parse_time= #{queryParam.timeRange}</if>-->

        <if test="queryParam.queryTime != null and queryParam.queryTime != ''">and parse_time = #{queryParam.queryTime}</if>
        <if test="queryParam.serverNodeName !=null and queryParam.serverNodeName !=''">and server_node_name = #{queryParam.serverNodeName}</if>
    </sql>
    <sql id="selectiveParamCdnTime2">
        <if test="queryParam.startTime != null and queryParam.startTime != ''">and parse_time &gt;= #{queryParam.startTime}</if>
        <if test="queryParam.endTime != null and queryParam.endTime != ''">and parse_time &lt; #{queryParam.endTime}</if>

        <if test="queryParam.userType != null and queryParam.userType != ''">and user_type = #{queryParam.userType}</if>
        <if test="queryParam.district != null and queryParam.district != ''">and district = #{queryParam.district}</if>
        <if test="queryParam.country != null and queryParam.country != ''">and country = #{queryParam.country}</if>
        <if test="queryParam.province != null and queryParam.province != ''">and province = #{queryParam.province}</if>
        <if test="queryParam.city != null and queryParam.city != ''">and city = #{queryParam.city}</if>
        <if test="queryParam.ispCode != null and queryParam.ispCode != ''">and isp_code = #{queryParam.ispCode}</if>
        <if test="queryParam.queryTime != null and queryParam.queryTime != ''">and parse_time = #{queryParam.queryTime}</if>
        <if test="queryParam.serverNodeName !=null and queryParam.serverNodeName !=''">and server_node_name = #{queryParam.serverNodeName}</if>
    </sql>
    <sql id="selectiveParamCdn2">
        <if test="queryParam.startTime != null and queryParam.startTime != ''">and parse_time &gt;= #{queryParam.startTime}</if>
        <if test="queryParam.endTime != null and queryParam.endTime != '' and queryParam.statisticsWay == 'every'">and parse_time &lt; #{queryParam.endTime}</if>
        <if test="queryParam.endTime != null and queryParam.endTime != '' and queryParam.statisticsWay != 'every'">and parse_time &lt; #{queryParam.endTime}</if>
        <if test="queryParam.business != null and queryParam.business != ''">and business ilike concat('%',#{queryParam.business},'%')</if>
        <if test="queryParam.userType != null and queryParam.userType != ''">and user_type = #{queryParam.userType}</if>
        <if test="queryParam.districtsCode != null and queryParam.districtsCode != ''">and districts_code = #{queryParam.districtsCode}</if>
        <if test="queryParam.country != null and queryParam.country != ''">and country = #{queryParam.country}</if>
        <if test="queryParam.province != null and queryParam.province != ''">and province = #{queryParam.province}</if>
        <if test="queryParam.city != null and queryParam.city != ''">and city = #{queryParam.city}</if>
        <if test="queryParam.district != null and queryParam.district != ''">and district = #{queryParam.district}</if>
        <if test="queryParam.isp != null and queryParam.isp != ''">and isp = #{queryParam.isp}</if>
        <if test="queryParam.ispCode != null and queryParam.ispCode != ''">and isp_code = #{queryParam.ispCode}</if>
        <!--        <if test="queryParam.statisticsWay != null and queryParam.statisticsWay == 'every'">  and parse_time= #{queryParam.timeRange}</if>-->

        <if test="queryParam.queryTime != null and queryParam.queryTime != ''">and parse_time = #{queryParam.queryTime}</if>
        <if test="queryParam.serverNodeName !=null and queryParam.serverNodeName !=''">and server_node_name = #{queryParam.serverNodeName}</if>
    </sql>

    <select id="countFindTrendListParam" resultType="java.lang.Long">
        select count(1) from
        (
            <if test="queryParam.netInRateMin != null or queryParam.netInRateMin != null">
                select * from (
            </if>
                    select
                    parse_time,
                    sum(a_record_parse_total_cnt) as a_record_parse_total_cnt,
                    sum(net_in_parse_total_cnt) as net_in_parse_total_cnt,
                    <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null"> if(a_record_parse_total_cnt == 0, 0.0, divide(net_in_parse_total_cnt * 100, a_record_parse_total_cnt)) as net_in_rate_val, </if>
                    website_app_name
                    from ${queryParam.queryTable}
                    <where>
                        <include refid="selectiveParam"/>
                        <if test = "queryParam.rankNumber != null and queryParam.rankNumber != ''">
                            and website_app_name global in (
                            select
                            website_app_name
                            from
                            ${queryParam.queryTable}
                            <where>
                                <include refid="selectiveParam"/>
                            </where>
                            group by
                            website_app_name
                            HAVING 1=1
                            <if test="queryParam.netInZero != null and queryParam.netInZero != ''">
                                and sum(net_in_parse_total_cnt) = 0
                            </if>
                            <if test="queryParam.withinZero != null and queryParam.withinZero != ''">
                                and sum(within_parse_total_cnt) = 0
                            </if>
                            order by sum(parse_total_cnt) desc limit #{queryParam.rankNumber}
                            )
                        </if>
                    </where>
                    group by parse_time, website_app_name, website_type
                    HAVING 1=1
                    <if test="queryParam.netInZero != null and queryParam.netInZero != ''">
                        and net_in_parse_total_cnt = 0
                    </if>
                    <if test="queryParam.withinZero != null and queryParam.withinZero != ''">
                        and sum(within_parse_total_cnt) = 0
                    </if>
            <if test="queryParam.netInRateMin != null or queryParam.netInRateMin != null">
                )
                <where>
                    <if test="queryParam.netInRateMin != null"> and net_in_rate_val &gt;= #{queryParam.netInRateMin}</if>
                    <if test="queryParam.netInRateMax != null"> and net_in_rate_val &lt;= #{queryParam.netInRateMax}</if>
                </where>
            </if>
            )
    </select>

    <select id="findTrendListByParam"
            resultType="com.yamu.data.sample.service.resources.entity.po.ResourceWebsiteTopNDetail">
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMin != null">
            select * from (
        </if>
            select
            <include refid="findTrendListSumColumn"/>
            from ${queryParam.queryTable}
            <where>
                <include refid="selectiveParam"/>
                <if test = "queryParam.rankNumber != null and queryParam.rankNumber != ''">
                    and website_app_name global in (
                    select
                    website_app_name
                    from
                    ${queryParam.queryTable}
                    <where>
                        <include refid="selectiveParam"/>
                    </where>
                    group by
                    website_app_name
                    HAVING 1=1
                    <if test="queryParam.netInZero != null and queryParam.netInZero != ''">
                        and sum(net_in_parse_total_cnt) = 0
                    </if>
                    <if test="queryParam.withinZero != null and queryParam.withinZero != ''">
                        and sum(within_parse_total_cnt) = 0
                    </if>
                    order by sum(parse_total_cnt) desc limit #{queryParam.rankNumber}
                    )
                </if>
            </where>
        group by parse_time, website_app_name, website_type,company_short_name
        HAVING 1=1
        <if test="queryParam.netInZero != null and queryParam.netInZero != ''">
            and net_in_parse_total_cnt = 0
        </if>
        <if test="queryParam.withinZero != null and queryParam.withinZero != ''">
            and within_parse_total_cnt = 0
        </if>
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMin != null">
            )
            <where>
                <if test="queryParam.netInRateMin != null"> and net_in_rate_val &gt;= #{queryParam.netInRateMin}</if>
                <if test="queryParam.netInRateMax != null"> and net_in_rate_val &lt;= #{queryParam.netInRateMax}</if>
            </where>
        </if>
        order by ${queryParam.orderBy}
        limit #{queryParam.offset}, #{queryParam.limit}
    </select>

    <select id="findNowTrendListByParam"
            resultType="com.yamu.data.sample.service.resources.entity.po.ResourceWebsiteTopNDetail">
        select * from(
        select *,
        row_number() OVER (ORDER BY parse_total_cnt DESC) rank_number
        from (
            <if test="queryParam.netInRateMin != null or queryParam.netInRateMin != null">
                select * from (
            </if>
                select
                <include refid="findLastTrendListSumColumn"/>
                from ${queryParam.queryTable}
                <where>
                    <include refid="selectiveParam"/>
                    <if test = "queryParam.rankNumber != null and queryParam.rankNumber != ''">
                        and website_app_name global in (
                        select
                        website_app_name
                        from
                        ${queryParam.queryTable}
                        <where>
                            <include refid="selectiveParam"/>
                        </where>
                        group by
                        website_app_name
                        HAVING 1=1
                        <if test="queryParam.netInZero != null and queryParam.netInZero != ''">
                            and sum(net_in_parse_total_cnt) = 0
                        </if>
                        <if test="queryParam.withinZero != null and queryParam.withinZero != ''">
                            and sum(within_parse_total_cnt) = 0
                        </if>
                        order by sum(parse_total_cnt) desc limit #{queryParam.rankNumber}
                        )
                    </if>
                </where>
                group by parse_time, website_app_name, website_type
                HAVING 1=1
                <if test="queryParam.netInZero != null and queryParam.netInZero != ''">
                    and net_in_parse_total_cnt = 0
                </if>
                <if test="queryParam.withinZero != null and queryParam.withinZero != ''">
                    and sum(within_parse_total_cnt) = 0
                </if>
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMin != null">
            )
            <where>
                <if test="queryParam.netInRateMin != null"> and net_in_rate_val &gt;= #{queryParam.netInRateMin}</if>
                <if test="queryParam.netInRateMax != null"> and net_in_rate_val &lt;= #{queryParam.netInRateMax}</if>
            </where>
        </if>
        order by parse_time desc,parse_total_cnt desc
        limit #{queryParam.offset}, #{queryParam.limit}))
        where rank_number &lt;= 20
        settings allow_experimental_window_functions = 1
    </select>

    <select id="findLastTrendListByParam"
            resultType="com.yamu.data.sample.service.resources.entity.po.ResourceWebsiteTopNDetail">
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMin != null">
            select * from (
        </if>
            select
            <include refid="findLastTrendListSumColumn"/>
            from ${queryParam.queryTable}
            <where>
                <include refid="selectiveParamByLastTime"/>
                and website_app_name global in
                <foreach collection="websites" open="(" close=")" separator="," item="item">
                    #{item}
                </foreach>
            </where>
            group by parse_time,  website_app_name
            HAVING 1=1
            <if test="queryParam.netInZero != null and queryParam.netInZero != ''">
                and net_in_parse_total_cnt = 0
            </if>
            <if test="queryParam.withinZero != null and queryParam.withinZero != ''">
                and sum(within_parse_total_cnt) = 0
            </if>
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMin != null">
            )
            <where>
                <if test="queryParam.netInRateMin != null"> and net_in_rate_val &gt;= #{queryParam.netInRateMin}</if>
                <if test="queryParam.netInRateMax != null"> and net_in_rate_val &lt;= #{queryParam.netInRateMax}</if>
            </where>
        </if>
        order by
        parse_time,
        parse_total_cnt desc
        settings allow_experimental_window_functions = 1
    </select>


    <select id="findTrendReportGroupByIspByParam"
            resultType="com.yamu.data.sample.service.resources.entity.po.ResourceWebsiteTopNDetail">
            select
                answer_first_isp,
                sum(a_record_parse_total_cnt) as a_record_parse_total_cnt
            from ${queryParam.queryTable}
            <where>
                <include refid="selectiveParamByRateReport"/>
                <if test = "queryParam.rankNumber != null and queryParam.rankNumber != ''">
                and website_app_name global in (
                select
                website_app_name
                from
                ${queryParam.queryTable}
                <where>
                    <include refid="selectiveParamByRateReport"/>
                </where>
                group by website_app_name
                order by sum(a_record_parse_total_cnt) desc limit #{queryParam.rankNumber}
                )
                </if>
            </where>
            group by answer_first_isp order by a_record_parse_total_cnt desc
    </select>

    <select id="findTrendReportGroupByParseByParam"
            resultType="com.yamu.data.sample.service.resources.entity.po.ResourceWebsiteTopNDetail">
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null">
            select * from (
        </if>
        select
        parse_time,
        sum(parse_total_cnt) as parse_total_cnt,
        sum(a_record_parse_total_cnt) as a_record_parse_total_cnt,
        sum(parse_success_cnt) as parse_success_cnt,
        sum(net_in_parse_total_cnt) as net_in_parse_total_cnt,
        sum(net_out_parse_total_cnt) as net_out_parse_total_cnt,
        sum(within_parse_total_cnt) as within_parse_total_cnt,
        sum(without_parse_total_cnt) as without_parse_total_cnt,
        sum(cdn_parse_total_cnt) as cdn_parse_total_cnt,
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null"> if(a_record_parse_total_cnt == 0, 0.0, divide(net_in_parse_total_cnt * 100, a_record_parse_total_cnt)) as net_in_rate_val, </if>
        sum(idc_parse_total_cnt) as idc_parse_total_cnt
        from ${queryParam.queryTable}
        <where>
            <choose>
                <when test="isTopN == true">
                    <include refid="selectiveParamByReport"/>
                    <if test = "queryParam.rankNumber != null and queryParam.rankNumber != ''">
                        and website_app_name global in (
                        select
                        website_app_name
                        from
                        ${queryParam.queryTable}
                        <where>
                            <include refid="selectiveParamByReport"/>
                        </where>
                        group by
                        website_app_name
                        order by sum(parse_total_cnt) desc limit #{queryParam.rankNumber}
                        )
                    </if>
                </when>
                <otherwise>
                    <include refid="selectiveParamByRateReport"/>
                    <if test = "queryParam.rankNumber != null and queryParam.rankNumber != ''">
                        and website_app_name global in (
                        select
                        website_app_name
                        from
                        ${queryParam.queryTable}
                        <where>
                            <include refid="selectiveParamByRateReport"/>
                        </where>
                        group by
                        website_app_name
                        order by sum(parse_total_cnt) desc limit #{queryParam.rankNumber}
                        )
                    </if>
                </otherwise>
            </choose>
        </where>
        group by parse_time order by parse_time
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null">
            )
            <where>
                <if test="queryParam.netInRateMin != null"> and net_in_rate_val &gt;= #{queryParam.netInRateMin}</if>
                <if test="queryParam.netInRateMax != null"> and net_in_rate_val &lt;= #{queryParam.netInRateMax}</if>
            </where>
        </if>
    </select>
    <select id="queryNetInParseGroupByDomainType"
            resultType="com.yamu.data.sample.service.resources.entity.po.ResourceWebsiteTopNDetail">
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null">
            select * from (
        </if>
            select
            website_app_name,
            sum(parse_total_cnt) as parse_total_cnt,
            sum(a_record_parse_total_cnt) as a_record_parse_total_cnt,
            <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null"> if(a_record_parse_total_cnt == 0, 0.0, divide(net_in_parse_total_cnt * 100, a_record_parse_total_cnt)) as net_in_rate_val, </if>
            sum(net_in_parse_total_cnt) as net_in_parse_total_cnt
            from ${queryParam.queryTable}
            <where>
                <include refid="selectiveParamByReport"/>
            </where>
            group by website_app_name
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null">
            )
            <where>
                <if test="queryParam.netInRateMin != null"> and net_in_rate_val &gt;= #{queryParam.netInRateMin}</if>
                <if test="queryParam.netInRateMax != null"> and net_in_rate_val &lt;= #{queryParam.netInRateMax}</if>
            </where>
        </if>
        order by parse_total_cnt desc limit #{queryParam.rankNumber}
    </select>

    <select id="countFindTrendListParamAll" resultType="java.lang.Long">
        select count(1) from
        (
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null">
            select * from (
        </if>
        select
        sum(a_record_parse_total_cnt) as a_record_parse_total_cnt,
        sum(net_in_parse_total_cnt) as net_in_parse_total_cnt,
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null"> if(a_record_parse_total_cnt == 0, 0.0, divide(net_in_parse_total_cnt * 100, a_record_parse_total_cnt)) as net_in_rate_val, </if>
        website_app_name
        from ${queryParam.queryTable}
        <where>
            <include refid="selectiveParam"/>
            <if test = "queryParam.rankNumber != null and queryParam.rankNumber != ''">
                and website_app_name global in (
                select
                website_app_name
                from
                ${queryParam.queryTable}
                <where>
                    <include refid="selectiveParam"/>
                </where>
                group by
                website_app_name
                HAVING 1=1
                <if test="queryParam.netInZero != null and queryParam.netInZero != ''">
                    and sum(net_in_parse_total_cnt) = 0
                </if>
                <if test="queryParam.withinZero != null and queryParam.withinZero != ''">
                    and sum(within_parse_total_cnt) = 0
                </if>
                order by sum(parse_total_cnt) desc limit #{queryParam.rankNumber}
                )
            </if>
        </where>
        group by website_app_name, website_type
        HAVING 1=1
        <if test="queryParam.netInZero != null and queryParam.netInZero != ''">
            and net_in_parse_total_cnt = 0
        </if>
        <if test="queryParam.withinZero != null and queryParam.withinZero != ''">
            and sum(within_parse_total_cnt) = 0
        </if>
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null">
            )
            <where>
                <if test="queryParam.netInRateMin != null"> and net_in_rate_val &gt;= #{queryParam.netInRateMin}</if>
                <if test="queryParam.netInRateMax != null"> and net_in_rate_val &lt;= #{queryParam.netInRateMax}</if>
            </where>
        </if>
        )
    </select>

    <select id="findTrendListByParamAll"
            resultType="com.yamu.data.sample.service.resources.entity.po.ResourceWebsiteTopNDetail">
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null">
            select * from (
        </if>
        select
        website_app_name,
        website_type,
        company_short_name,
        sum(parse_total_cnt) as parse_total_cnt,
        sum(a_record_parse_total_cnt) as a_record_parse_total_cnt,
        sum(parse_success_cnt) as parse_success_cnt,
        sum(net_in_parse_total_cnt) as net_in_parse_total_cnt,
        sum(net_out_parse_total_cnt) as net_out_parse_total_cnt,
        sum(within_parse_total_cnt) as within_parse_total_cnt,
        sum(without_parse_total_cnt) as without_parse_total_cnt,
        sum(cdn_parse_total_cnt) as cdn_parse_total_cnt,
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null"> if(a_record_parse_total_cnt == 0, 0.0, divide(net_in_parse_total_cnt * 100, a_record_parse_total_cnt)) as net_in_rate_val, </if>
        sum(idc_parse_total_cnt) as idc_parse_total_cnt,
        idc_parse_total_cnt+sum(zl_parse_total_cnt + tt_parse_total_cnt + zx_parse_total_cnt) as icpAccuracyParseTotalCnt
        from ${queryParam.queryTable}
        <where>
            <include refid="selectiveParam"/>
            <if test = "queryParam.rankNumber != null and queryParam.rankNumber != ''">
                and website_app_name global in (
                select
                website_app_name
                from
                ${queryParam.queryTable}
                <where>
                    <include refid="selectiveParam"/>
                </where>
                group by
                website_app_name
                HAVING 1=1
                <if test="queryParam.netInZero != null and queryParam.netInZero != ''">
                    and sum(net_in_parse_total_cnt) = 0
                </if>
                <if test="queryParam.withinZero != null and queryParam.withinZero != ''">
                    and sum(within_parse_total_cnt) = 0
                </if>
                order by sum(parse_total_cnt) desc limit #{queryParam.rankNumber}
                )
            </if>
        </where>
        group by website_app_name,website_type,company_short_name
        HAVING 1=1
        <if test="queryParam.netInZero != null and queryParam.netInZero != ''">
            and net_in_parse_total_cnt = 0
        </if>
        <if test="queryParam.withinZero != null and queryParam.withinZero != ''">
            and within_parse_total_cnt = 0
        </if>
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null">
            )
            <where>
                <if test="queryParam.netInRateMin != null"> and net_in_rate_val &gt;= #{queryParam.netInRateMin}</if>
                <if test="queryParam.netInRateMax != null"> and net_in_rate_val &lt;= #{queryParam.netInRateMax}</if>
            </where>
        </if>
        order by ${queryParam.orderBy}
        limit #{queryParam.offset}, #{queryParam.limit}
    </select>

    <select id="findNowTrendListByParamAll"
            resultType="com.yamu.data.sample.service.resources.entity.po.ResourceWebsiteTopNDetail">
        select * from(
        select *,
        row_number() OVER (ORDER BY parse_total_cnt DESC) rank_number
        from (
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null">
            select * from (
        </if>
        select
        website_app_name,
        sum(a_record_parse_total_cnt) as a_record_parse_total_cnt,
        sum(net_in_parse_total_cnt) as net_in_parse_total_cnt,
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null"> if(a_record_parse_total_cnt == 0, 0.0, divide(net_in_parse_total_cnt * 100, a_record_parse_total_cnt)) as net_in_rate_val, </if>
        sum(parse_total_cnt) as parse_total_cnt
        from ${queryParam.queryTable}
        <where>
            <include refid="selectiveParam"/>
            <if test = "queryParam.rankNumber != null and queryParam.rankNumber != ''">
                and website_app_name global in (
                select
                website_app_name
                from
                ${queryParam.queryTable}
                <where>
                    <include refid="selectiveParam"/>
                </where>
                group by
                website_app_name
                HAVING 1=1
                <if test="queryParam.netInZero != null and queryParam.netInZero != ''">
                    and sum(net_in_parse_total_cnt) = 0
                </if>
                <if test="queryParam.withinZero != null and queryParam.withinZero != ''">
                    and sum(within_parse_total_cnt) = 0
                </if>
                order by sum(parse_total_cnt) desc limit #{queryParam.rankNumber}
                )
            </if>
        </where>
        group by  website_app_name, website_type
        HAVING 1=1
        <if test="queryParam.netInZero != null and queryParam.netInZero != ''">
            and net_in_parse_total_cnt = 0
        </if>
        <if test="queryParam.withinZero != null and queryParam.withinZero != ''">
            and sum(within_parse_total_cnt) = 0
        </if>
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null">
            )
            <where>
                <if test="queryParam.netInRateMin != null"> and net_in_rate_val &gt;= #{queryParam.netInRateMin}</if>
                <if test="queryParam.netInRateMax != null"> and net_in_rate_val &lt;= #{queryParam.netInRateMax}</if>
            </where>
        </if>
        order by parse_total_cnt desc
        limit #{queryParam.offset}, #{queryParam.limit}))
        where rank_number &lt;= 20
        settings allow_experimental_window_functions = 1
    </select>

    <select id="findLastTrendListByParamAll"
            resultType="com.yamu.data.sample.service.resources.entity.po.ResourceWebsiteTopNDetail">
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null">
            select * from (
        </if>
        select
        website_app_name,
        sum(a_record_parse_total_cnt) as a_record_parse_total_cnt,
        sum(net_in_parse_total_cnt) as net_in_parse_total_cnt,
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null"> if(a_record_parse_total_cnt == 0, 0.0, divide(net_in_parse_total_cnt * 100, a_record_parse_total_cnt)) as net_in_rate_val, </if>
        sum(parse_total_cnt) as parse_total_cnt
        from ${queryParam.queryTable}
        <where>
            <include refid="selectiveParamByLastTime"/>
            and website_app_name in
            <foreach collection="websites" open="(" close=")" separator="," item="item">
                #{item}
            </foreach>
        </where>
        group by  website_app_name
        HAVING 1=1
        <if test="queryParam.netInZero != null and queryParam.netInZero != ''">
            and net_in_parse_total_cnt = 0
        </if>
        <if test="queryParam.withinZero != null and queryParam.withinZero != ''">
            and sum(within_parse_total_cnt) = 0
        </if>
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null">
            )
            <where>
                <if test="queryParam.netInRateMin != null"> and net_in_rate_val &gt;= #{queryParam.netInRateMin}</if>
                <if test="queryParam.netInRateMax != null"> and net_in_rate_val &lt;= #{queryParam.netInRateMax}</if>
            </where>
        </if>
        order by
        parse_total_cnt desc
        settings allow_experimental_window_functions = 1
    </select>

    <select id="findUserSource"
            resultType="com.yamu.data.sample.service.resources.entity.po.ResourceWebsiteUserSource">
        select
        answer_first_city,
        website_app_name,
        sum(parse_total_cnt) as parse_total_cnt,
        sum(parse_total_cnt) over (PARTITION by website_app_name ) as ptc
        from ${queryParam.queryTable}
        <where>
            <include refid="selectiveFindUserSourceParam"/>
            <if test = "(queryParam.rankNumber != null and queryParam.rankNumber != '') and (queryParam.websiteAppName == null or queryParam.websiteAppName == '')">
                and website_app_name global in (
                select website_app_name
                from ${queryParam.queryTable}
                <where> 1=1
                    <include refid="selectiveFindUserSourceParam"/>
                </where>
                group by website_app_name
                order by sum(parse_total_cnt) desc limit #{queryParam.rankNumber}
                )
            </if>
        </where>
        group by answer_first_city,website_app_name
        order by ptc desc,website_app_name,parse_total_cnt desc
    </select>

    <select id="findUserSourceExcelNoResource"
            resultType="com.yamu.data.sample.service.resources.entity.po.ResourceWebsiteUserSource">
        select
        answer_first_city,
        website_app_name,
        sum(parse_total_cnt) as parse_total_cnt,
        sum(parse_total_cnt) over (PARTITION by website_app_name ) as ptc
        from ${queryParam.queryTable}
        <where> 1=1
            <include refid="selectiveFindUserSourceExcelParam"/>
            and website_app_name global in (
                select website_app_name
                from ${queryParam.queryTable}
                <where> 1=1
                    <include refid="selectiveFindUserSourceExcelParam"/>
                </where>
                group by website_app_name
                HAVING 1=1
                <if test="queryParam.netInZero != null and queryParam.netInZero != ''">
                    and sum(net_in_parse_total_cnt) = 0
                </if>
                <if test="queryParam.withinZero != null and queryParam.withinZero != ''">
                    and sum(within_parse_total_cnt) = 0
                </if>
                <if test="queryParam.rankNumber != null and queryParam.rankNumber != ''">
                    order by sum(parse_total_cnt) desc limit #{queryParam.rankNumber}
                </if>
            )
        </where>
        group by answer_first_city,website_app_name
        order by ptc desc,website_app_name,parse_total_cnt desc
    </select>

    <select id="findUserSourceExcel"
            resultType="com.yamu.data.sample.service.resources.entity.po.ResourceWebsiteUserSource">
        select
        answer_first_city,
        website_app_name,
        sum(parse_total_cnt) as parse_total_cnt,
        sum(parse_total_cnt) over (PARTITION by website_app_name ) as ptc
        from ${queryParam.queryTable}
        <where>
            <include refid="selectiveFindUserSourceExcelParam"/>
            <include refid="selectiveParamExcel"/>
        </where>
        group by answer_first_city,website_app_name
        order by ptc desc,website_app_name,parse_total_cnt desc
    </select>

    <select id="resourceDistributionProvince"
            resultType="com.yamu.data.sample.service.resources.entity.po.ResourceDistributionProvinceData">
        select answer_first_province,sum(parse_total_cnt) as parse_total_cnt
        from ${queryTable}
        <where> 1=1
            <include refid="selectiveDistributionProvinceParam"/>
        </where>
        group by answer_first_province
        order by parse_total_cnt desc
    </select>

    <select id="resourceDistributionProvinceDetail"
            resultType="com.yamu.data.sample.service.resources.entity.po.ResourceDistributionProvinceDetail">
        select answer_first_province,answer_first_isp,sum(parse_total_cnt) as parse_total_cnt
        from ${queryTable}
        <where> 1=1
            <include refid="selectiveDistributionProvinceParam"/>
        </where>
        group by answer_first_province , answer_first_isp
        order by answer_first_province,parse_total_cnt desc
    </select>

    <select id="getIpDetailTotal"
            resultType="java.lang.Long">
        select count(*) from (
        select
        answer_first_ip,answer_first_province,answer_first_city,answer_first_isp
        from ${queryTable}
        <where> 1=1
            <include refid="selectiveDistributionProvinceParam"/>
        </where>
        group by case when  answer_first_ip is null or answer_first_ip ='' then '其他' else answer_first_ip end as answer_first_ip,
        answer_first_province,answer_first_city, answer_first_isp)
    </select>

    <select id="getIpDetailList"
            resultType="com.yamu.data.sample.service.resources.entity.po.ResourceIpDetailData">
        select  answer_first_ip,answer_first_province as province,answer_first_city as city,answer_first_isp,parse_total_cnt
        from (
        select
        answer_first_ip,answer_first_province,answer_first_city,answer_first_isp,sum(parse_total_cnt) as parse_total_cnt
        from ${queryTable}
        <where> 1=1
            <include refid="selectiveDistributionProvinceParam"/>
        </where>
        group by case when answer_first_ip is null or answer_first_ip ='' then '其他' else answer_first_ip end as answer_first_ip,
        answer_first_province,answer_first_city,answer_first_isp
        order by parse_total_cnt desc
        limit #{queryParam.offset}, #{queryParam.limit})
    </select>

    <select id="getIpDetailExcelList"
            resultType="com.yamu.data.sample.service.resources.entity.po.ResourceIpDetailData">
        select  answer_first_ip,answer_first_province as province,answer_first_city as city,answer_first_isp,parse_total_cnt
        from (
        select
        answer_first_ip,answer_first_province,answer_first_city,answer_first_isp,sum(parse_total_cnt) as parse_total_cnt
        from ${queryTable}
        <where> 1=1
            <include refid="selectiveDistributionProvinceExcelParam"/>
            <include refid="selectiveParamExcel"/>
        </where>
        group by case when answer_first_ip is null or answer_first_ip ='' then '其他' else answer_first_ip end as answer_first_ip,
        answer_first_province,answer_first_city,answer_first_isp
        order by parse_total_cnt desc
        limit #{queryParam.offset}, #{queryParam.limit}
        )
    </select>

    <sql id="findTrendListColumn">
        parse_time,
        website_app_name,
        website_type,
        parse_total_cnt,
        a_record_parse_total_cnt,
        parse_success_cnt,
        net_in_parse_total_cnt,
        net_out_parse_total_cnt,
        within_parse_total_cnt,
        without_parse_total_cnt,
        cdn_parse_total_cnt,
        idc_parse_total_cnt
    </sql>

    <sql id="findTrendListSumColumn">
        parse_time,
        parse_time as parse_time_last,
        website_app_name,
        website_type,
        company_short_name,
        sum(parse_total_cnt) as parse_total_cnt,
        sum(a_record_parse_total_cnt) as a_record_parse_total_cnt,
        sum(parse_success_cnt) as parse_success_cnt,
        sum(net_in_parse_total_cnt) as net_in_parse_total_cnt,
        sum(net_out_parse_total_cnt) as net_out_parse_total_cnt,
        sum(within_parse_total_cnt) as within_parse_total_cnt,
        sum(without_parse_total_cnt) as without_parse_total_cnt,
        sum(cdn_parse_total_cnt) as cdn_parse_total_cnt,
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null"> if(a_record_parse_total_cnt == 0, 0.0, divide(net_in_parse_total_cnt * 100, a_record_parse_total_cnt)) as net_in_rate_val, </if>
        sum(idc_parse_total_cnt) as idc_parse_total_cnt,
        idc_parse_total_cnt+sum(zl_parse_total_cnt + tt_parse_total_cnt + zx_parse_total_cnt) as icpAccuracyParseTotalCnt
    </sql>

    <sql id="findTrendListSumColumnIncludeRate">
        parse_time,
        website_app_name,
        website_type,
        sum(parse_total_cnt) as parse_total_cnt,
        sum(a_record_parse_total_cnt) as a_record_parse_total_cnt,
        sum(parse_success_cnt) as parse_success_cnt,
        sum(net_in_parse_total_cnt) as net_in_parse_total_cnt,
        sum(net_out_parse_total_cnt) as net_out_parse_total_cnt,
        sum(within_parse_total_cnt) as within_parse_total_cnt,
        sum(without_parse_total_cnt) as without_parse_total_cnt,
        sum(cdn_parse_total_cnt) as cdn_parse_total_cnt,
        sum(idc_parse_total_cnt) as idc_parse_total_cnt
    </sql>

    <sql id="findLastTrendListSumColumn">
        parse_time,
        parse_time as parse_time_last,
        website_app_name,
        sum(a_record_parse_total_cnt) as a_record_parse_total_cnt,
        sum(net_in_parse_total_cnt) as net_in_parse_total_cnt,
        <if test="queryParam.netInRateMin != null or queryParam.netInRateMax != null"> if(a_record_parse_total_cnt == 0, 0.0, divide(net_in_parse_total_cnt * 100, a_record_parse_total_cnt)) as net_in_rate_val, </if>
        sum(parse_total_cnt) as parse_total_cnt
    </sql>

    <sql id="selectiveParam">
        <if test="queryParam.startTime != null and queryParam.startTime != ''">and parse_time &gt;= #{queryParam.startTime}</if>
        <if test="queryParam.endTime != null and queryParam.endTime != ''">and parse_time &lt; #{queryParam.endTime}</if>
        <if test="queryParam.websiteAppName != null and queryParam.websiteAppName != ''">and website_app_name ilike concat('%',#{queryParam.websiteAppName},'%')</if>
        <if test="queryParam.websiteType != null and queryParam.websiteType != ''">and website_type = #{queryParam.websiteType}</if>
        <if test="queryParam.userType != null and queryParam.userType != ''">and user_type = #{queryParam.userType}</if>
        <if test="queryParam.districtsCode != null and queryParam.districtsCode != ''">and districts_code = #{queryParam.districtsCode}</if>
        <if test="queryParam.country != null and queryParam.country != ''">and country = #{queryParam.country}</if>
        <if test="queryParam.province != null and queryParam.province != ''">and province = #{queryParam.province}</if>
        <if test="queryParam.city != null and queryParam.city != ''">and city = #{queryParam.city}</if>
        <if test="queryParam.district != null and queryParam.district != ''">and district = #{queryParam.district}</if>
        <if test="queryParam.isp != null and queryParam.isp != ''">and isp = #{queryParam.isp}</if>
        <if test="queryParam.ispCode != null and queryParam.ispCode != ''">and isp_code = #{queryParam.ispCode}</if>
        <if test="queryParam.serverNodeName !=null and queryParam.serverNodeName !=''">and server_node_name = #{queryParam.serverNodeName}</if>
    </sql>

    <sql id="selectiveParamByLastTime">
        <if test="queryParam.lastStartTime != null and queryParam.lastStartTime != ''">and parse_time &gt;= #{queryParam.lastStartTime}</if>
        <if test="queryParam.lastEndTime != null and queryParam.lastEndTime != ''">and parse_time &lt; #{queryParam.lastEndTime}</if>
        <if test="queryParam.websiteAppName != null and queryParam.websiteAppName != ''">and website_app_name ilike concat('%',#{queryParam.websiteAppName},'%')</if>
        <if test="queryParam.websiteType != null and queryParam.websiteType != ''">and website_type = #{queryParam.websiteType}</if>
        <if test="queryParam.userType != null and queryParam.userType != ''">and user_type = #{queryParam.userType}</if>
        <if test="queryParam.districtsCode != null and queryParam.districtsCode != ''">and districts_code = #{queryParam.districtsCode}</if>
        <if test="queryParam.country != null and queryParam.country != ''">and country = #{queryParam.country}</if>
        <if test="queryParam.province != null and queryParam.province != ''">and province = #{queryParam.province}</if>
        <if test="queryParam.city != null and queryParam.city != ''">and city = #{queryParam.city}</if>
        <if test="queryParam.district != null and queryParam.district != ''">and district = #{queryParam.district}</if>
        <if test="queryParam.isp != null and queryParam.isp != ''">and isp = #{queryParam.isp}</if>
        <if test="queryParam.ispCode != null and queryParam.ispCode != ''">and isp_code = #{queryParam.ispCode}</if>
        <if test="queryParam.serverNodeName !=null and queryParam.serverNodeName !=''">and server_node_name = #{queryParam.serverNodeName}</if>
    </sql>

    <sql id="selectiveParamByReport">
        <if test="queryParam.startTime != null and queryParam.startTime != ''">and parse_time &gt;= #{queryParam.startTime}</if>
        <if test="queryParam.endTime != null and queryParam.endTime != ''">and parse_time &lt; #{queryParam.endTime}</if>
        <if test="queryParam.websiteAppName != null and queryParam.websiteAppName != ''">and website_app_name ilike concat('%',#{queryParam.websiteAppName},'%')</if>
        <if test="queryParam.websiteType != null and queryParam.websiteType != ''">and website_type = #{queryParam.websiteType}</if>
        <if test="queryParam.userType != null and queryParam.userType != ''">and user_type = #{queryParam.userType}</if>
        <if test="queryParam.districtsCode != null and queryParam.districtsCode != ''">and districts_code = #{queryParam.districtsCode}</if>
        <if test="queryParam.country != null and queryParam.country != ''">and country = #{queryParam.country}</if>
        <if test="queryParam.province != null and queryParam.province != ''">and province = #{queryParam.province}</if>
        <if test="queryParam.city != null and queryParam.city != ''">and city = #{queryParam.city}</if>
        <if test="queryParam.district != null and queryParam.district != ''">and district = #{queryParam.district}</if>
        <if test="queryParam.isp != null and queryParam.isp != ''">and isp = #{queryParam.isp}</if>
        <if test="queryParam.ispCode != null and queryParam.ispCode != ''">and isp_code = #{queryParam.ispCode}</if>
        <if test="queryParam.serverNodeName !=null and queryParam.serverNodeName !=''">and server_node_name = #{queryParam.serverNodeName}</if>
    </sql>

    <sql id="selectiveParamByRateReport">
        <if test="queryParam.startTime != null and queryParam.startTime != ''">and parse_time &gt;= #{queryParam.startTime}</if>
        <if test="queryParam.endTime != null and queryParam.endTime != ''">and parse_time &lt; #{queryParam.endTime}</if>
        <if test="queryParam.websiteAppName != null and queryParam.websiteAppName != ''">and website_app_name = #{queryParam.websiteAppName}</if>
        <if test="queryParam.websiteType != null and queryParam.websiteType != ''">and website_type = #{queryParam.websiteType}</if>
        <if test="queryParam.userType != null and queryParam.userType != ''">and user_type = #{queryParam.userType}</if>
        <if test="queryParam.districtsCode != null and queryParam.districtsCode != ''">and districts_code = #{queryParam.districtsCode}</if>
        <if test="queryParam.country != null and queryParam.country != ''">and country = #{queryParam.country}</if>
        <if test="queryParam.province != null and queryParam.province != ''">and province = #{queryParam.province}</if>
        <if test="queryParam.city != null and queryParam.city != ''">and city = #{queryParam.city}</if>
        <if test="queryParam.district != null and queryParam.district != ''">and district = #{queryParam.district}</if>
        <if test="queryParam.isp != null and queryParam.isp != ''">and isp = #{queryParam.isp}</if>
        <if test="queryParam.ispCode != null and queryParam.ispCode != ''">and isp_code = #{queryParam.ispCode}</if>
        <if test="queryParam.serverNodeName !=null and queryParam.serverNodeName !=''">and server_node_name = #{queryParam.serverNodeName}</if>
    </sql>

    <sql id="selectiveFindUserSourceParam">
        <if test="queryParam.startTime != null and queryParam.startTime != ''">and parse_time &gt;= #{queryParam.startTime}</if>
        <if test="queryParam.endTime != null and queryParam.endTime != ''">and parse_time &lt; #{queryParam.endTime}</if>
        <if test="queryParam.websiteAppName != null and queryParam.websiteAppName != ''">and website_app_name = #{queryParam.websiteAppName}</if>
        <if test="queryParam.ipType != null and queryParam.ipType != ''">and ip_type = #{queryParam.ipType}</if>
        <if test="queryParam.userType != null and queryParam.userType != ''">and user_type = #{queryParam.userType}</if>
        <if test="queryParam.province != null and queryParam.province != ''">and province = #{queryParam.province}</if>
        <if test="queryParam.city != null and queryParam.city != ''">and city = #{queryParam.city}</if>
        <if test="queryParam.district != null and queryParam.district != ''">and district = #{queryParam.district}</if>
        <if test="queryParam.ispCode != null and queryParam.ispCode != ''">and isp_code = #{queryParam.ispCode}</if>
        <if test="queryParam.queryTime != null and queryParam.queryTime != ''">and parse_time = #{queryParam.queryTime}</if>
        <if test="queryParam.serverNodeName !=null and queryParam.serverNodeName !=''">and server_node_name = #{queryParam.serverNodeName}</if>
    </sql>

    <sql id="selectiveFindUserSourceExcelParam">
        <if test="queryParam.startTime != null and queryParam.startTime != ''">and parse_time &gt;= #{queryParam.startTime}</if>
        <if test="queryParam.endTime != null and queryParam.endTime != ''">and parse_time &lt; #{queryParam.endTime}</if>
        <if test="queryParam.websiteAppName != null and queryParam.websiteAppName != ''">and website_app_name ilike concat('%',#{queryParam.websiteAppName},'%')</if>
        <if test="queryParam.ipType != null and queryParam.ipType != ''">and ip_type = #{queryParam.ipType}</if>
        <if test="queryParam.userType != null and queryParam.userType != ''">and user_type = #{queryParam.userType}</if>
        <if test="queryParam.province != null and queryParam.province != ''">and province = #{queryParam.province}</if>
        <if test="queryParam.city != null and queryParam.city != ''">and city = #{queryParam.city}</if>
        <if test="queryParam.district != null and queryParam.district != ''">and district = #{queryParam.district}</if>
        <if test="queryParam.ispCode != null and queryParam.ispCode != ''">and isp_code = #{queryParam.ispCode}</if>
        <if test="queryParam.queryTime != null and queryParam.queryTime != ''">and parse_time = #{queryParam.queryTime}</if>
        <if test="queryParam.serverNodeName !=null and queryParam.serverNodeName !=''">and server_node_name = #{queryParam.serverNodeName}</if>
    </sql>

    <sql id="selectiveDistributionProvinceParam">
        <if test="queryParam.startTime != null and queryParam.startTime != ''">and parse_time &gt;= #{queryParam.startTime}</if>
        <if test="queryParam.endTime != null and queryParam.endTime != ''">and parse_time &lt; #{queryParam.endTime}</if>
        <if test="queryParam.websiteAppName != null and queryParam.websiteAppName != ''">and website_app_name = #{queryParam.websiteAppName}</if>
        <if test="queryParam.userType != null and queryParam.userType != ''">and user_type = #{queryParam.userType}</if>
        <if test="queryParam.province != null and queryParam.province != ''">and province = #{queryParam.province}</if>
        <if test="queryParam.city != null and queryParam.city != ''">and city = #{queryParam.city}</if>
        <if test="queryParam.district != null and queryParam.district != ''">and district = #{queryParam.district}</if>
        <if test="queryParam.ispCode != null and queryParam.ispCode != ''">and isp_code = #{queryParam.ispCode}</if>
        <if test="queryParam.queryTime != null and queryParam.queryTime != ''">and parse_time = #{queryParam.queryTime}</if>
        <if test="queryParam.serverNodeName !=null and queryParam.serverNodeName !=''">and server_node_name = #{queryParam.serverNodeName}</if>
    </sql>

    <sql id="selectiveDistributionProvinceExcelParam">
        <if test="queryParam.startTime != null and queryParam.startTime != ''">and parse_time &gt;= #{queryParam.startTime}</if>
        <if test="queryParam.endTime != null and queryParam.endTime != ''">and parse_time &lt; #{queryParam.endTime}</if>
        <if test="queryParam.websiteAppName != null and queryParam.websiteAppName != ''">and website_app_name ilike concat('%',#{queryParam.websiteAppName},'%')</if>
        <if test="queryParam.userType != null and queryParam.userType != ''">and user_type = #{queryParam.userType}</if>
        <if test="queryParam.province != null and queryParam.province != ''">and province = #{queryParam.province}</if>
        <if test="queryParam.city != null and queryParam.city != ''">and city = #{queryParam.city}</if>
        <if test="queryParam.district != null and queryParam.district != ''">and district = #{queryParam.district}</if>
        <if test="queryParam.ispCode != null and queryParam.ispCode != ''">and isp_code = #{queryParam.ispCode}</if>
        <if test="queryParam.queryTime != null and queryParam.queryTime != ''">and parse_time = #{queryParam.queryTime}</if>
        <if test="queryParam.serverNodeName !=null and queryParam.serverNodeName !=''">and server_node_name = #{queryParam.serverNodeName}</if>
    </sql>

    <sql id="selectiveParamExcel">
        and website_app_name global in (
        select website_app_name from (
        <if test="websiteTopNDetail.netInRateMin != null or websiteTopNDetail.netInRateMax != null">
            select * from (
        </if>
        select
        website_app_name,
        website_type,
        sum(parse_total_cnt) as parse_total_cnt,
        sum(a_record_parse_total_cnt) as a_record_parse_total_cnt,
        sum(parse_success_cnt) as parse_success_cnt,
        sum(net_in_parse_total_cnt) as net_in_parse_total_cnt,
        sum(net_out_parse_total_cnt) as net_out_parse_total_cnt,
        sum(within_parse_total_cnt) as within_parse_total_cnt,
        sum(without_parse_total_cnt) as without_parse_total_cnt,
        sum(cdn_parse_total_cnt) as cdn_parse_total_cnt,
        <if test="websiteTopNDetail.netInRateMin != null or websiteTopNDetail.netInRateMax != null"> if(a_record_parse_total_cnt == 0, 0.0, divide(net_in_parse_total_cnt * 100, a_record_parse_total_cnt)) as net_in_rate_val, </if>
        sum(idc_parse_total_cnt) as idc_parse_total_cnt
        from ${websiteTopNDetail.queryTable}
        <where>
            <include refid="selectiveParamWebsiteTopNDetail"/>
            <if test = "websiteTopNDetail.rankNumber != null and websiteTopNDetail.rankNumber != ''">
                and website_app_name global in (
                select
                website_app_name
                from
                ${websiteTopNDetail.queryTable}
                <where>
                    <include refid="selectiveParamWebsiteTopNDetail"/>
                </where>
                group by
                website_app_name
                order by sum(parse_total_cnt) desc limit #{websiteTopNDetail.rankNumber}
                )
            </if>
        </where>
        group by  website_app_name, website_type
        <if test="websiteTopNDetail.netInRateMin != null or websiteTopNDetail.netInRateMax != null">
            )
            <where>
                <if test="websiteTopNDetail.netInRateMin != null"> and net_in_rate_val &gt;= #{websiteTopNDetail.netInRateMin}</if>
                <if test="websiteTopNDetail.netInRateMax != null"> and net_in_rate_val &lt;= #{websiteTopNDetail.netInRateMax}</if>
            </where>
        </if>
        order by parse_total_cnt desc
        limit #{websiteTopNDetail.offset}, #{websiteTopNDetail.limit}
        )
        )
    </sql>

    <sql id="selectiveParamWebsiteTopNDetail">
        <if test="websiteTopNDetail.startTime != null and websiteTopNDetail.startTime != ''">and parse_time &gt;= #{websiteTopNDetail.startTime}</if>
        <if test="websiteTopNDetail.endTime != null and websiteTopNDetail.endTime != ''">and parse_time &lt; #{websiteTopNDetail.endTime}</if>
        <if test="websiteTopNDetail.websiteAppName != null and websiteTopNDetail.websiteAppName != ''">and website_app_name ilike concat('%',#{websiteTopNDetail.websiteAppName},'%')</if>
        <if test="websiteTopNDetail.websiteType != null and websiteTopNDetail.websiteType != ''">and website_type = #{websiteTopNDetail.websiteType}</if>
        <if test="websiteTopNDetail.userType != null and websiteTopNDetail.userType != ''">and user_type = #{websiteTopNDetail.userType}</if>
        <if test="websiteTopNDetail.districtsCode != null and websiteTopNDetail.districtsCode != ''">and districts_code = #{websiteTopNDetail.districtsCode}</if>
        <if test="websiteTopNDetail.country != null and websiteTopNDetail.country != ''">and country = #{websiteTopNDetail.country}</if>
        <if test="websiteTopNDetail.province != null and websiteTopNDetail.province != ''">and province = #{websiteTopNDetail.province}</if>
        <if test="websiteTopNDetail.city != null and websiteTopNDetail.city != ''">and city = #{websiteTopNDetail.city}</if>
        <if test="websiteTopNDetail.district != null and websiteTopNDetail.district != ''">and district = #{websiteTopNDetail.district}</if>
        <if test="websiteTopNDetail.isp != null and websiteTopNDetail.isp != ''">and isp = #{websiteTopNDetail.isp}</if>
        <if test="websiteTopNDetail.ispCode != null and websiteTopNDetail.ispCode != ''">and isp_code = #{websiteTopNDetail.ispCode}</if>
        <if test="queryParam.serverNodeName !=null and queryParam.serverNodeName !=''">and server_node_name = #{queryParam.serverNodeName}</if>
    </sql>

</mapper>
