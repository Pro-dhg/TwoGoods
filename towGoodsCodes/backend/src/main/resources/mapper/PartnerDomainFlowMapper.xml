<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yamu.data.sample.service.resources.mapper.PartnerDomainFlowMapper">
    <select id="countQueryGroupByDomainName" resultType="java.lang.Long">
        select count(*) from (
            select
            rpt.domain_name
            from ${queryParam.queryTable} rpt LEFT JOIN dim.dim_dial_domain_record dddr on rpt.domain_name = dddr.domain_name
            <where>
                <include refid="selectiveParam"/>
                <include refid="equalsDistributeState"/>
            </where>
            group by rpt.domain_name,dddr.domain_name
            order by sum(rpt.net_out_parse_flow_total) desc
            <if test="queryParam.rankNumber != null and queryParam.rankNumber != ''">
                limit #{queryParam.rankNumber}
            </if>
        )
    </select>
    <select id="queryGroupByDomainName"
            resultType="com.yamu.data.sample.service.resources.entity.po.PartnerDomainFlow">
        select * from (
            select
            rpt.domain_name as domain_name,
            dddr.domain_name as dial_domain_name,
            case
            when dial_domain_name is null or dial_domain_name = '' then '未下发'
            else '已下发' end                                   as distribute_state,
            sum(net_out_parse_flow_total) as net_out_parse_flow_total,
            sum(net_out_parse_total_cnt) as net_out_parse_total_cnt,
            sum(parse_total_cnt) as parse_total_cnt,
            sum(parse_success_cnt) as parse_success_cnt,
            sum(parse_flow_total) as parse_flow_total,
            sum(net_in_parse_flow_total) as net_in_parse_flow_total,
            sum(net_in_parse_total_cnt) as net_in_parse_total_cnt,
            sum(within_parse_total_cnt) as within_parse_total_cnt,
            sum(without_parse_total_cnt) as without_parse_total_cnt,
            sum(cdn_parse_total_cnt) as cdn_parse_total_cnt,
            sum(idc_parse_total_cnt) as idc_parse_total_cnt
            from ${queryParam.queryTable} rpt LEFT JOIN dim.dim_dial_domain_record dddr on rpt.domain_name = dddr.domain_name
            <where>
                <include refid="selectiveParam"/>
                <include refid="equalsDistributeState"/>
            </where>
            group by rpt.domain_name,dddr.domain_name
            order by net_out_parse_flow_total desc
            <if test="queryParam.rankNumber != null and queryParam.rankNumber != ''">
                limit #{queryParam.rankNumber}
            </if>
        )
        order by ${queryParam.orderBy}
        <if test="queryParam.limit != null and queryParam.limit != ''">
            limit #{queryParam.limit}
            <if test="queryParam.offset != null and queryParam.offset != ''">
                offset #{queryParam.offset}
            </if>
        </if>
    </select>
    <select id="queryGroupByParseTime"
            resultType="com.yamu.data.sample.service.resources.entity.po.PartnerDomainFlow">
        select parse_time,
        sum(net_out_parse_flow_total) as net_out_parse_flow_total,
        sum(net_out_parse_total_cnt) as net_out_parse_total_cnt,
        sum(parse_total_cnt) as parse_total_cnt,
        sum(parse_success_cnt) as parse_success_cnt,
        sum(parse_flow_total) as parse_flow_total,
        sum(net_in_parse_flow_total) as net_in_parse_flow_total,
        sum(net_in_parse_total_cnt) as net_in_parse_total_cnt,
        sum(within_parse_total_cnt) as within_parse_total_cnt,
        sum(without_parse_total_cnt) as without_parse_total_cnt,
        sum(cdn_parse_total_cnt) as cdn_parse_total_cnt,
        sum(idc_parse_total_cnt) as idc_parse_total_cnt
        from ${queryParam.queryTable} as rpt
        <where>
            <include refid="selectiveParamEqualsDomainName"/>
        </where>
        group by parse_time
        order by parse_time
    </select>
    <select id="findTopDomain" resultType="java.lang.String">
        select
        domain_name
        from ${queryParam.queryTable} as rpt
        <where>
            <include refid="selectiveParam"/>
        </where>
        group by domain_name
        order by sum(net_out_parse_flow_total) desc
        limit ${queryParam.rankNumber}
    </select>

    <sql id="equalsDistributeState">
        <choose>
            <when test="queryParam.distributeState == '已下发'">
                and (dddr.domain_name is not null and dddr.domain_name !='')
            </when>
            <when test="queryParam.distributeState == '未下发'">
                and (dddr.domain_name is null or dddr.domain_name ='')
            </when>
        </choose>
    </sql>

    <sql id="selectiveParam">
        <if test="queryParam.startTime != null">and rpt.parse_time &gt;= #{queryParam.startTime}</if>
        <if test="queryParam.endTime != null">and rpt.parse_time &lt;= #{queryParam.endTime}</if>
        <if test="queryParam.domainName != null and queryParam.domainName != ''">and rpt.domain_name ilike concat('%',#{queryParam.domainName},'%')</if>
        <if test="queryParam.domainType != null and queryParam.domainType != ''">and rpt.domain_type = #{queryParam.domainType}</if>
        <if test="queryParam.domainTypeKey != null and queryParam.domainTypeKey!=''">and rpt.domain_type_key = #{queryParam.domainTypeKey} </if>
        <if test="queryParam.districtsCode != null and queryParam.districtsCode != ''">and rpt.districts_code = #{queryParam.districtsCode}</if>
        <if test="queryParam.country != null and queryParam.country != ''">and rpt.country = #{queryParam.country}</if>
        <if test="queryParam.province != null and queryParam.province != ''">and rpt.province = #{queryParam.province}</if>
        <if test="queryParam.city != null and queryParam.city != ''">and rpt.city = #{queryParam.city}</if>
        <if test="queryParam.district != null and queryParam.district != ''">and rpt.district = #{queryParam.district}</if>
        <if test="queryParam.isp != null and queryParam.isp != ''">and rpt.isp = #{queryParam.isp}</if>
        <if test="queryParam.ispCode != null and queryParam.ispCode != ''">and rpt.isp_code = #{queryParam.ispCode}</if>
        <if test="queryParam.serverNodeName !=null and queryParam.serverNodeName !=''">and server_node_name = #{queryParam.serverNodeName}</if>
    </sql>

    <sql id="selectiveParamEqualsDomainName">
        <if test="queryParam.startTime != null">and rpt.parse_time &gt;= #{queryParam.startTime}</if>
        <if test="queryParam.endTime != null">and rpt.parse_time &lt;= #{queryParam.endTime}</if>
        <if test="queryParam.domainName != null and queryParam.domainName != ''">and rpt.domain_name = #{queryParam.domainName}</if>
        <if test="queryParam.domainType != null and queryParam.domainType != ''">and rpt.domain_type = #{queryParam.domainType}</if>
        <if test="queryParam.domainTypeKey != null and queryParam.domainTypeKey!=''">and rpt.domain_type_key = #{queryParam.domainTypeKey} </if>
        <if test="queryParam.districtsCode != null and queryParam.districtsCode != ''">and rpt.districts_code = #{queryParam.districtsCode}</if>
        <if test="queryParam.country != null and queryParam.country != ''">and rpt.country = #{queryParam.country}</if>
        <if test="queryParam.province != null and queryParam.province != ''">and rpt.province = #{queryParam.province}</if>
        <if test="queryParam.city != null and queryParam.city != ''">and rpt.city = #{queryParam.city}</if>
        <if test="queryParam.district != null and queryParam.district != ''">and rpt.district = #{queryParam.district}</if>
        <if test="queryParam.isp != null and queryParam.isp != ''">and rpt.isp = #{queryParam.isp}</if>
        <if test="queryParam.ispCode != null and queryParam.ispCode != ''">and rpt.isp_code = #{queryParam.ispCode}</if>
        <if test="queryParam.serverNodeName !=null and queryParam.serverNodeName !=''">and server_node_name = #{queryParam.serverNodeName}</if>
    </sql>
</mapper>
